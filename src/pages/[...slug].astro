---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import Layout from "../layouts/PublicationLayout.astro";
import TableOfContents from "@components/PublicationToc.vue";
import { Breadcrumbs } from "astro-breadcrumbs";
import { Icon } from 'astro-icon'
import 'astro-breadcrumbs/breadcrumbs.css';
import Author from "@components/content/Author.astro";
import Tag from "@components/content/Tag.astro";

export async function getStaticPaths() {
  const publication2023Entries = await getCollection("publication2023");

  return publication2023Entries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry, collection: publication2023Entries },
  }));
}

interface Props {
  entry: CollectionEntry<"publication2023">;
  collection: CollectionEntry<"publication2023">[];
}
const { entry, collection } = Astro.props;
const { Content, headings } = await entry.render();

/**
 * Filter the collection to only include the items that are needed
 */
const filteredCollection = collection.map((item) => {
  return {
    title: item.data.title,
    slug: item.slug,
    isCurrent: item.id === entry.id,
    chapter: item.data.chapter,
    order: item.data.order,
  };
});

/**
 * Group the collection by chapter
 */
const groupedByChapter = filteredCollection.reduce<{ [key: number]: typeof filteredCollection}>((acc, item) => {
  const chapter = item.chapter;
  if (!acc[chapter]) {
    acc[chapter] = [];
  }
  acc[chapter].push(item);
  acc[chapter].sort((a, b) => a.order - b.order);

  return acc;
}, {});

/**
 * Sort the collection by the order property
 */
const sortedCollection = filteredCollection.sort((a, b) => a.order - b.order);

const chapterTitles = [
  "0. Introduction",
  "1. Redefining progress: confronting the challenges of digitalisation and sustainability",
  "2. Values for transformation: foundation for a socio-ecological digitalisation",
  "3. Transformative change: new concepts and paradigms to upgrade current socio-technicalstructures",
  "4. Beyond business as usual: use cases for more sustainable tech design",
  "5. Politics under pressure: necessary changes on the political level",
  "6. A collective effort: the power of civil society driving sustainable change",
  "7. Closure"
]

const currentChapter = entry.data.chapter;

const authors = entry.data.authors;
const tag = entry.data.tag;
---

<Layout seo={entry.data.seo} contentModifierClass="publication" chapterThemeClass={currentChapter}>

  <Breadcrumbs indexText="home">
    <Icon slot="separator" name="lucide:chevron-right" width="24" height="24" />
  </Breadcrumbs>

  {
    authors && authors.length > 0 && (
      <Author authors={entry.data.authors}></Author>
    )
  }

  {
    tag && (
      <Tag tag={entry.data.tag}></Tag>
    )
  }

  <Content />

  <TableOfContents
    headings={headings}
    chapters={groupedByChapter}
    chapterTitles={chapterTitles}
    client:only
    slot="sidebar"
  />
</Layout>
